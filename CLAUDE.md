# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

StoryOS v3 is an interactive narrative platform with a **FastAPI backend** and **React (Vite) frontend**. The backend manages game state, user sessions, and LLM integration (Grok API via OpenAI client), while the frontend provides a responsive control center for running and visualizing stories. The system supports REST APIs and WebSocket communication for real-time story streaming.

## Commands

### Backend

```bash
# Setup
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt

# Run development server (with hot reload)
uvicorn backend.api.main:app --reload --port 8000

# Run tests
pytest backend/tests

# Run specific test
pytest backend/tests/test_health.py -v
```

### Frontend

```bash
# Setup
cd frontend
npm install

# Run development server (port 8080)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview
```

### Full Stack (Docker)

```bash
# Start all services (API, frontend, MongoDB, Redis)
docker-compose up --build

# Stop services
docker-compose down
```

## Architecture

### Backend (`backend/`)

The backend follows a layered architecture that bridges legacy Streamlit code with modern FastAPI endpoints:

- **`api/`**: FastAPI application and routing
  - `main.py`: Application entrypoint, router registration, CORS configuration
  - `routers/`: REST and WebSocket endpoint handlers (auth, game, scenarios, admin, websocket)
  - `dependencies.py`: Dependency injection for services
  - `middleware.py`: CORS and other middleware configuration
  - `schemas.py`: Request/response models specific to API layer

- **`services/`**: Async facades that wrap legacy synchronous code
  - `game_service.py`: Async adapter for game logic, converts blocking generators to async streams
  - `auth_service.py`: JWT token generation/validation, user authentication
  - Services use `asyncio.to_thread()` to bridge sync/async boundaries

- **`core/`**: Legacy gameplay logic from Streamlit version
  - `game_logic.py`: Original game mechanics (DO NOT expand; new logic goes in `services/`)
  - Accessed through services layer, not directly from routers

- **`models/`**: Pydantic schemas shared across services and API
  - Domain models: `GameSession`, `Message`, `VisualizationTask`, `VisualPrompts`
  - Reused by both MongoDB operations and API serialization

- **`utils/`**: Data and LLM integration helpers
  - `db_utils.py`: MongoDB connection and CRUD operations via `DatabaseManager`
  - `llm_utils.py`: Grok API integration via OpenAI client with streaming support
  - `db_*_actions.py`: Domain-specific database operations (users, scenarios, sessions, chats, etc.)
  - `streamlit_shim.py`: Compatibility layer for legacy Streamlit code

- **`config/`**: Environment-driven settings
  - `settings.py`: Configuration loaded from environment variables

- **`logging_config.py`**: Centralized logging configuration

- **`tests/`**: Pytest-based test suite

### Frontend (`frontend/src/`)

React + TypeScript SPA with Redux Toolkit for state management:

- **`pages/`**: Route-level components
  - `Login.tsx`, `MainMenu.tsx`, `NewGame.tsx`, `LoadGame.tsx`, `Game.tsx`, `Scenarios.tsx`, `AdminPanel.tsx`
  - Each page corresponds to a major application view

- **`components/`**: Reusable React components (PascalCase)
  - `Tooltip.tsx` and other UI elements

- **`store/`**: Redux Toolkit state management
  - `index.ts`: Store configuration
  - `slices/`: Redux slices for auth, game state, etc.

- **`api/`**: HTTP client configuration
  - `client.ts`: Axios instance with auth interceptors

- **`hooks/`**: Custom React hooks (useX pattern)
  - Colocated with related logic

- **`types/`**: TypeScript type definitions

- **`App.tsx`**: Main application component with routing
- **`main.tsx`**: Application entrypoint

### Key Integration Patterns

**WebSocket Communication**: Real-time story streaming uses WebSocket connections managed by `GameWebSocketManager` in `backend/api/routers/websocket.py`. The manager maintains active connections per session and broadcasts story chunks as they're generated by the LLM. Frontend connects via `ws://<host>/ws/game/{session_id}?token=<JWT>`.

**Async Stream Adaptation**: Legacy `game_logic` functions return synchronous generators. `GameService` wraps these with `asyncio.to_thread()` and converts them to async generators for FastAPI streaming responses.

**LLM Integration**: Grok API (via OpenAI client) in `llm_utils.py` streams completions. The `LLMUtility` class handles prompt formatting, logging to `logs/` directory, and token streaming.

**MongoDB Collections**:
- `users`: User accounts with bcrypt-hashed passwords
- `scenarios`: Story blueprints with system prompts
- `game_sessions`: Active/completed game states
- `chats`: Message history per session
- `visualization_tasks`: Background image generation tasks (Kling.ai integration)

**Authentication**: JWT tokens (HS256) with configurable expiration (default 43200 minutes). Tokens required for game/admin routes, validated via `get_current_user` dependency.

## Environment Variables

Required in `.env` (not tracked in git):

```bash
# Database
MONGODB_URI=mongodb://localhost:27017/storyos

# Auth
JWT_SECRET_KEY=your-secret-key-here
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=43200

# LLM Integration
XAI_API_KEY=your-grok-api-key

# Image Generation (optional)
KLING_ACCESS_KEY=your-kling-access-key
KLING_SECRET_KEY=your-kling-secret-key

# CORS (optional, defaults to localhost:5173,3000)
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# Frontend (in frontend/.env)
VITE_API_URL=http://localhost:8000/api
VITE_WS_URL=ws://localhost:8000/ws
```

## Code Style

### Backend (Python)
- PEP 8 with type hints on all functions
- `snake_case` for functions/modules, `PascalCase` for classes
- Use `from __future__ import annotations` for forward references
- Services should be thin adapters; complex logic goes in `utils/`
- Mock LLM calls in tests for deterministic results
- Use `get_logger()` from `logging_config.py` for all logging

### Frontend (TypeScript)
- Components: `PascalCase`, functional components preferred
- Hooks: `useX` naming pattern
- Props: TypeScript interfaces, not types
- Redux: Colocate slices in `store/slices/`
- API calls: Use axios instance from `api/client.ts`

### Commits
- Format: `<type>(<scope>): <description>`
- Types: `feat`, `fix`, `refactor`, `test`, `docs`, `chore`
- Scopes: `backend`, `frontend`, or specific module
- Example: `feat(backend): add websocket retry logic`

## Development Workflow

1. **New Feature Development**:
   - Backend: Add route in `api/routers/`, service method in `services/`, models in `models/`
   - Frontend: Add page/component, API call in `api/client.ts`, Redux slice if needed
   - Add tests: `backend/tests/test_*.py` for backend, `frontend/src/tests/` for frontend

2. **Testing Requirements**:
   - Backend: Mock MongoDB and LLM calls, use pytest fixtures
   - Frontend: Add Vitest or Playwright tests (create `frontend/src/tests/` if needed)
   - All tests must pass before PR: `pytest backend/tests && npm run build`

3. **MongoDB Schema Changes**:
   - Update Pydantic models in `backend/models/`
   - Add/update database actions in `backend/utils/db_*_actions.py`
   - Update example JSONs in `backend/models/example_json/`

4. **New External API Integration**:
   - Add utility class in `backend/utils/` (follow pattern of `LLMUtility`)
   - Add configuration to `backend/config/settings.py`
   - Document required env vars in README.md and docker-compose.yml

## Security

- Store secrets in `.env` (git-ignored)
- Passwords hashed with bcrypt
- JWT tokens for auth (validate on all protected routes)
- Input validation on all endpoints (Pydantic models)
- Admin features gated by role check
- CORS configured in `backend/api/middleware.py`

## Legacy Code Notes

- Original Streamlit app migrated to FastAPI/React architecture
- Legacy code in `backend/core/` kept for compatibility
- `streamlit_shim.py` provides `st` object stubs for legacy imports
- New features should NOT extend `core/`â€”use `services/` instead
- Async services wrap synchronous core logic for FastAPI compatibility